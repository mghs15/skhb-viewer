<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<title>SKHB検索</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

<script src='https://unpkg.com/maplibre-gl/dist/maplibre-gl.js'></script>
<link href='https://unpkg.com/maplibre-gl/dist/maplibre-gl.css' rel='stylesheet' />
<script src="https://unpkg.com/pmtiles@2.5.0/dist/index.js"></script>

<script>


</script>

<style>
body { margin:0; padding:0; }
#map {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 100%;
  height: 100%;
}

</style>

</head>
<body>

  <div id="map"></div>

</div>

<script>
let protocol = new pmtiles.Protocol();
maplibregl.addProtocol("pmtiles", protocol.tile);

const map = new maplibregl.Map({
  container: 'map',
  hash: true,
  style: 'https://mghs15.github.io/styling-tools-for-gsi-optbv/mono2.json', 
  center: [135, 35], // starting position [lng, lat]
  minZoom: 0,
  zoom: 9 // starting zoom
});

map.on('load', () => {
  
  
  map.addSource("overlay", {
    "type": "vector",
    "tiles":["pmtiles://https://mghs15.github.io/skhb-20231213-data/skhb.pmtiles/{z}/{x}/{y}"],
    "attribution":"指定緊急避難場所（国土地理院）",
    "minzoom":0,"maxzoom":11,
  });


  // 都道府県・市町村ポイント
  map.addLayer({
    id: "overlay-prefmuni",
    type: "circle",
    source: "overlay",
    "source-layer": "group",
    minzoom: 7,
    maxzoom: 9,
    paint: {
      "circle-blur": 0.2,
      "circle-color": [
        "interpolate", ["linear"],
        ["to-number", ["get", "施設・場所名"]],
        1,
        "#51bbd6",
        100,
        "#f1f075",
        750,
        "#f28cb1",
        2000,
        "#ff0000"
      ],
      "circle-radius": [
        "interpolate", ["linear"],
        ["to-number", ["get", "施設・場所名"]],
        1,
        10,
        100,
        20,
        750,
        30
      ]
    }
  });
  
  map.addLayer({
    id: "overlay-prefmuni-text",
    type: "symbol",
    source: "overlay",
    "source-layer": "group",
    minzoom: 0,
    maxzoom: 9,
    layout: {
      "text-field": [
        "format",
        [
          "coalesce",
          ["get", "都道府県名及び市町村名"],
          ["get", "都道府県"]
        ], {},
        "\n",
        ["get", "施設・場所名"], {}
      ],
      "text-font": ["NotoSansJP-Regular"],
      "text-size": 10,
      "text-allow-overlap": true,
      "symbol-sort-key": ["to-number", ["get", "施設・場所名"]]
    },
    paint: {
      "text-color": "#0000FF",
      "text-halo-width": 1,
      "text-halo-color": "#FFFFFF"
    }
  });

  // クラスタリングポイント
  map.addLayer({
    id: "overlay-cluster",
    type: "circle",
    source: "overlay",
    "source-layer": "cluster",
    minzoom: 9,
    maxzoom: 11,
    filter: ["has", "point_count"],
    paint: {
      "circle-blur": 0.2,
      "circle-color": [
        "interpolate", ["linear"],
        ["get", "point_count"],
        1,
        "#51bbd6",
        100,
        "#f1f075",
        750,
        "#f28cb1"
      ],
      "circle-radius": [
        "interpolate", ["linear"],
        ["get", "point_count"],
        1,
        10,
        100,
        20,
        750,
        30
      ]
    }
  });

  map.addLayer({
    id: "overlay-cluster-count",
    type: "symbol",
    source: "overlay",
    "source-layer": "cluster",
    minzoom: 9,
    maxzoom: 11,
    filter: ["has", "point_count"],
    layout: {
      "text-field": ["get", "point_count_abbreviated"],
      "text-font": ["NotoSansJP-Regular"],
      "text-size": 12
    },
    paint: {
      "text-halo-width": 1,
      "text-halo-color": "#FFFFFF"
    }
  });


  // 単独ポイント
  map.addLayer({
    id: "overlay",
    type: "circle",
    source: "overlay",
    "source-layer": "cluster",
    minzoom: 11,
    maxzoom: 24,
    paint: {
      "circle-blur": 0.2,
      "circle-color": "#0000ff",
      "circle-radius": 4,
      "circle-stroke-width": 1,
      "circle-stroke-color": "#ffffff",
    }
  });

});

</script>

</body>
</html>

